 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel - Digital Notice Board</title>

  <!-- Styles -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"/>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">
        <i class="fas fa-bullhorn me-2"></i>Digital Notice Board
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="/analytics">Analytics</a></li>
          <li class="nav-item"><a class="nav-link active" href="/admin">Admin</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Login Section -->
  <div id="loginSection" class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card shadow">
          <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-lock me-2"></i>Admin Login</h4>
          </div>
          <div class="card-body">
            <form id="loginForm">
              <div class="mb-3">
                <label class="form-label">Password</label>
                <input type="password" class="form-control" id="loginPassword" placeholder="Enter admin password" required/>
                <small class="text-muted">Default password: admin123</small>
              </div>
              <div id="loginError" class="alert alert-danger d-none"></div>
              <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-sign-in-alt me-2"></i>Login
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="container mt-4 d-none">
    <div class="row">
      <div class="col-12 d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold"><i class="fas fa-tools me-2"></i>Admin Panel</h2>
        <button class="btn btn-danger" id="logoutBtn">
          <i class="fas fa-sign-out-alt me-2"></i>Logout
        </button>
      </div>
    </div>

    <!-- Create Notice -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card shadow">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Create New Notice</h5>
          </div>
          <div class="card-body">
            <form id="noticeForm">
              <div class="row">
                <div class="col-md-8">
                  <div class="mb-3">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-control" id="noticeTitle" placeholder="Enter notice title" required/>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="mb-3">
                    <label class="form-label">Author</label>
                    <input type="text" class="form-control" id="noticeAuthor" placeholder="Your name" value="Admin" required/>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Content</label>
                <textarea class="form-control" id="noticeContent" rows="5" placeholder="Enter notice content" required></textarea>
              </div>

              <div class="row">
                <div class="col-md-4">
                  <div class="mb-3">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="noticeCategory" required>
                      <option value="general">General</option>
                      <option value="events">Events</option>
                      <option value="announcements">Announcements</option>
                      <option value="updates">Updates</option>
                      <option value="urgent">Urgent</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="mb-3">
                    <label class="form-label">Priority</label>
                    <select class="form-select" id="noticePriority" required>
                      <option value="low">Low</option>
                      <option value="medium" selected>Medium</option>
                      <option value="high">High</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                  <button type="submit" class="btn btn-success w-100">
                    <i class="fas fa-paper-plane me-2"></i>Publish Notice
                  </button>
                </div>
              </div>

              <div id="successMessage" class="alert alert-success d-none mt-3">
                <i class="fas fa-check-circle me-2"></i>Notice published successfully!
              </div>
              <div id="errorMessage" class="alert alert-danger d-none mt-3"></div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Existing Notices -->
    <div class="row">
      <div class="col-12">
        <div class="card shadow">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Manage Existing Notices</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th>Title</th>
                    <th>Category</th>
                    <th>Priority</th>
                    <th>Date</th>
                    <th style="width: 120px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="noticesTableBody">
                  <tr>
                    <td colspan="5" class="text-center">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div id="tableError" class="alert alert-danger d-none"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Confirm Delete</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this notice? This action cannot be undone.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ---------- Helpers ----------
    const $ = (id) => document.getElementById(id);
    const show = (el) => el.classList.remove('d-none');
    const hide = (el) => el.classList.add('d-none');

    async function fetchJSON(url, options = {}) {
      const res = await fetch(url, {
        credentials: 'include', // keep session cookie with every request
        headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },
        ...options
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || `${res.status} ${res.statusText}`);
      return data;
    }

    // ---------- State ----------
    let currentNoticeToDelete = null;

    // ---------- Login ----------
    $('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      hide($('loginError'));
      try {
        const data = await fetchJSON('/api/login', {
          method: 'POST',
          body: JSON.stringify({ password: $('loginPassword').value })
        });
        if (data.success) {
          hide($('loginSection'));
          show($('adminPanel'));
          loadNoticesForManagement();
        } else {
          $('loginError').textContent = 'Invalid password';
          show($('loginError'));
        }
      } catch (err) {
        $('loginError').textContent = 'Login error: ' + err.message;
        show($('loginError'));
      }
    });

    // ---------- Logout ----------
    $('logoutBtn').addEventListener('click', async () => {
      try {
        await fetchJSON('/api/logout', { method: 'POST' });
      } catch (e) { /* ignore */ }
      show($('loginSection'));
      hide($('adminPanel'));
      $('loginPassword').value = '';
    });

    // ---------- Create Notice ----------
    $('noticeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      hide($('successMessage'));
      hide($('errorMessage'));

      const notice = {
        title: $('noticeTitle').value.trim(),
        content: $('noticeContent').value.trim(),
        author: $('noticeAuthor').value.trim(),
        category: $('noticeCategory').value,
        priority: $('noticePriority').value
      };

      try {
        const result = await fetchJSON('/api/notices', {
          method: 'POST',
          body: JSON.stringify(notice)
        });

        if (result.success) {
          show($('successMessage'));
          $('noticeForm').reset();
          $('noticeAuthor').value = 'Admin';
          // Refresh existing notices
          await loadNoticesForManagement();
          setTimeout(() => hide($('successMessage')), 2500);
        }
      } catch (err) {
        $('errorMessage').textContent = 'Error: ' + err.message;
        show($('errorMessage'));
      }
    });
// ---------- Load Notices ----------
async function loadNoticesForManagement() {
  const tbody = document.getElementById('noticesTableBody');
  const tableError = document.getElementById('tableError');

  // spinner
  tbody.innerHTML = `
    <tr>
      <td colspan="5" class="text-center">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </td>
    </tr>`;

  tableError?.classList.add('d-none');
  try {
    const notices = await fetchJSON('/api/notices', { method: 'GET' });

    tbody.innerHTML = '';

    if (!Array.isArray(notices) || notices.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center">No notices found</td></tr>';
      return;
    }

    const priorityBadge = { high: 'danger', medium: 'warning', low: 'success' };

    notices.forEach((notice) => {
      const dateTxt = notice.timestamp
        ? new Date(notice.timestamp).toLocaleString()
        : '-';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${notice.title || '-'}</td>
        <td><span class="badge bg-primary text-uppercase">${notice.category || 'general'}</span></td>
        <td><span class="badge bg-${priorityBadge[notice.priority] || 'secondary'} text-uppercase">${notice.priority || 'low'}</span></td>
        <td>${dateTxt}</td>
        <td>
          <button class="btn btn-sm btn-danger" data-id="${notice.id}">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      `;

      // Delete handler
      tr.querySelector('button.btn-danger').addEventListener('click', () => {
        window.currentNoticeToDelete = notice.id;
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
      });

      tbody.appendChild(tr);
    });
  } catch (err) {
    if (tableError) {
      tableError.textContent = 'Error loading notices: ' + err.message;
      tableError.classList.remove('d-none');
    }
    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Failed to load notices</td></tr>';
  }
}
// attach delete handler
tr.querySelector('button.btn-danger').addEventListener('click', () => {
  currentNoticeToDelete = notice.id;
  const modalEl = document.getElementById('deleteModal');   // ✅ no '#'
  const modal = new bootstrap.Modal(modalEl);               // ✅ pass element
  modal.show();
});

tbody.appendChild(tr);

// ---------- Confirm Delete ----------
document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
  if (!currentNoticeToDelete) return;

  try {
    const result = await fetchJSON(`/api/notices/${currentNoticeToDelete}`, { method: 'DELETE' }); // ✅ includes credentials
    if (result.success) {
      const modalEl = document.getElementById('deleteModal');                  // ✅ no '#'
      const modal = bootstrap.Modal.getInstance(modalEl);                      // ✅ element instance
      modal.hide();
      currentNoticeToDelete = null;
      loadNoticesForManagement();                                              // ✅ refresh list
    }
  } catch (err) {
    alert('Error deleting notice: ' + err.message);
  }
});



</script>

 
  </script>
</body>
</html>
